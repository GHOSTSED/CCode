<code class="hljs coffeescript has-numbering" style="display: block; padding: 0px; color: inherit; box-sizing: border-box; font-family: 'Source Code Pro', monospace;font-size:undefined; white-space: pre; border-radius: 0px; word-wrap: normal; background: transparent;">SSL* <span class="hljs-attribute" style="box-sizing: border-box; color: rgb(0, 136, 0);">CEventBaseMgr</span>::CreateSSL(evutil_socket_t& fd) { <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(!CConfiger::GetInstance()->GetEnableSSL())</span> { <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX</span>* <span class="hljs-title" style="box-sizing: border-box;">ctx</span> = <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; <span class="hljs-title" style="box-sizing: border-box;">SSL</span>* <span class="hljs-title" style="box-sizing: border-box;">ssl</span> = <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; <span class="hljs-title" style="box-sizing: border-box;">ctx</span> = <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_new</span> <span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(SSLv23_method())</span>; <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">( ctx == NULL)</span> { <span class="hljs-title" style="box-sizing: border-box;">printf</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"SSL_CTX_new error!\n"</span>)</span>; <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } // 要求校验对方证书 <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_set_verify</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx, SSL_VERIFY_NONE, NULL)</span>; // 加载<span class="hljs-title" style="box-sizing: border-box;">CA</span>的证书 <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(!SSL_CTX_load_verify_locations(ctx, CA_CERT_FILE, NULL))</span> { <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">printf</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"SSL_CTX_load_verify_locations error!\n"</span>)</span>; <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } // 加载自己的证书 <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(SSL_CTX_use_certificate_file(ctx, SERVER_CERT_FILE, SSL_FILETYPE_PEM) <= <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>)</span> { <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">printf</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"SSL_CTX_use_certificate_file error!\n"</span>)</span>; <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } // 加载自己的私钥 <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(SSL_CTX_use_PrivateKey_file(ctx, SERVER_KEY_FILE, SSL_FILETYPE_PEM) <= <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>)</span> { <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">printf</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"SSL_CTX_use_PrivateKey_file error!\n"</span>)</span>; <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } // 判定私钥是否正确 <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(!SSL_CTX_check_private_key(ctx))</span> { <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">printf</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"SSL_CTX_check_private_key error!\n"</span>)</span>; <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } // 将连接付给<span class="hljs-title" style="box-sizing: border-box;">SSL</span> <span class="hljs-title" style="box-sizing: border-box;">ssl</span> = <span class="hljs-title" style="box-sizing: border-box;">SSL_new</span> <span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(!ssl)</span> { <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">printf</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"SSL_new error!\n"</span>)</span>; <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; } <span class="hljs-title" style="box-sizing: border-box;">SSL_set_fd</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ssl, fd)</span>; <span class="hljs-title" style="box-sizing: border-box;">bool</span> <span class="hljs-title" style="box-sizing: border-box;">isContinue</span> = <span class="hljs-title" style="box-sizing: border-box;">true</span>; <span class="hljs-title" style="box-sizing: border-box;">while</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(isContinue)</span> { <span class="hljs-title" style="box-sizing: border-box;">isContinue</span> = <span class="hljs-title" style="box-sizing: border-box;">false</span>; <span class="hljs-title" style="box-sizing: border-box;">if</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(SSL_accept(ssl) != <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>)</span> { <span class="hljs-title" style="box-sizing: border-box;">int</span> <span class="hljs-title" style="box-sizing: border-box;">icode</span> = -1; <span class="hljs-title" style="box-sizing: border-box;">int</span> <span class="hljs-title" style="box-sizing: border-box;">iret</span> = <span class="hljs-title" style="box-sizing: border-box;">SSL_get_error</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ssl, icode)</span>; <span class="hljs-title" style="box-sizing: border-box;">if</span> <span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(iret == SSL_ERROR_WANT_READ)</span> { <span class="hljs-title" style="box-sizing: border-box;">isContinue</span> = <span class="hljs-title" style="box-sizing: border-box;">true</span>; } <span class="hljs-title" style="box-sizing: border-box;">else</span> { <span class="hljs-title" style="box-sizing: border-box;">SSL_CTX_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ctx)</span>; <span class="hljs-title" style="box-sizing: border-box;">SSL_free</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(ssl)</span>; <span class="hljs-title" style="box-sizing: border-box;">ctx</span> = <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; <span class="hljs-title" style="box-sizing: border-box;">ssl</span> = <span class="hljs-title" style="box-sizing: border-box;">NULL</span>; <span class="hljs-title" style="box-sizing: border-box;">break</span>; } } <span class="hljs-title" style="box-sizing: border-box;">else</span> <span class="hljs-title" style="box-sizing: border-box;">break</span>; } <span class="hljs-title" style="box-sizing: border-box;">return</span> <span class="hljs-title" style="box-sizing: border-box;">ssl</span>; }</span></code><ul class="pre-numbering" style="box-sizing: border-box; position: absolute; width: 50px; top: 0px; left: 0px; margin: 0px; padding: 6px 0px 40px; border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); list-style: none; text-align: right; background-color: rgb(238, 238, 238);"><li style="box-sizing: border-box; padding: 0px 5px;">1</li><li style="box-sizing: border-box; padding: 0px 5px;">2</li><li style="box-sizing: border-box; padding: 0px 5px;">3</li><li style="box-sizing: border-box; padding: 0px 5px;">4</li><li style="box-sizing: border-box; padding: 0px 5px;">5</li><li style="box-sizing: border-box; padding: 0px 5px;">6</li><li style="box-sizing: border-box; padding: 0px 5px;">7</li><li style="box-sizing: border-box; padding: 0px 5px;">8</li><li style="box-sizing: border-box; padding: 0px 5px;">9</li><li style="box-sizing: border-box; padding: 0px 5px;">10</li><li style="box-sizing: border-box; padding: 0px 5px;">11</li><li style="box-sizing: border-box; padding: 0px 5px;">12</li><li style="box-sizing: border-box; padding: 0px 5px;">13</li><li style="box-sizing: border-box; padding: 0px 5px;">14</li><li style="box-sizing: border-box; padding: 0px 5px;">15</li><li style="box-sizing: border-box; padding: 0px 5px;">16</li><li style="box-sizing: border-box; padding: 0px 5px;">17</li><li style="box-sizing: border-box; padding: 0px 5px;">18</li><li style="box-sizing: border-box; padding: 0px 5px;">19</li><li style="box-sizing: border-box; padding: 0px 5px;">20</li><li style="box-sizing: border-box; padding: 0px 5px;">21</li><li style="box-sizing: border-box; padding: 0px 5px;">22</li><li style="box-sizing: border-box; padding: 0px 5px;">23</li><li style="box-sizing: border-box; padding: 0px 5px;">24</li><li style="box-sizing: border-box; padding: 0px 5px;">25</li><li style="box-sizing: border-box; padding: 0px 5px;">26</li><li style="box-sizing: border-box; padding: 0px 5px;">27</li><li style="box-sizing: border-box; padding: 0px 5px;">28</li><li style="box-sizing: border-box; padding: 0px 5px;">29</li><li style="box-sizing: border-box; padding: 0px 5px;">30</li><li style="box-sizing: border-box; padding: 0px 5px;">31</li><li style="box-sizing: border-box; padding: 0px 5px;">32</li><li style="box-sizing: border-box; padding: 0px 5px;">33</li><li style="box-sizing: border-box; padding: 0px 5px;">34</li><li style="box-sizing: border-box; padding: 0px 5px;">35</li><li style="box-sizing: border-box; padding: 0px 5px;">36</li><li style="box-sizing: border-box; padding: 0px 5px;">37</li><li style="box-sizing: border-box; padding: 0px 5px;">38</li><li style="box-sizing: border-box; padding: 0px 5px;">39</li><li style="box-sizing: border-box; padding: 0px 5px;">40</li><li style="box-sizing: border-box; padding: 0px 5px;">41</li><li style="box-sizing: border-box; padding: 0px 5px;">42</li><li style="box-sizing: border-box; padding: 0px 5px;">43</li><li style="box-sizing: border-box; padding: 0px 5px;">44</li><li style="box-sizing: border-box; padding: 0px 5px;">45</li><li style="box-sizing: border-box; padding: 0px 5px;">46</li><li style="box-sizing: border-box; padding: 0px 5px;">47</li><li style="box-sizing: border-box; padding: 0px 5px;">48</li><li style="box-sizing: border-box; padding: 0px 5px;">49</li><li style="box-sizing: border-box; padding: 0px 5px;">50</li><li style="box-sizing: border-box; padding: 0px 5px;">51</li><li style="box-sizing: border-box; padding: 0px 5px;">52</li><li style="box-sizing: border-box; padding: 0px 5px;">53</li><li style="box-sizing: border-box; padding: 0px 5px;">54</li><li style="box-sizing: border-box; padding: 0px 5px;">55</li><li style="box-sizing: border-box; padding: 0px 5px;">56</li><li style="box-sizing: border-box; padding: 0px 5px;">57</li><li style="box-sizing: border-box; padding: 0px 5px;">58</li><li style="box-sizing: border-box; padding: 0px 5px;">59</li><li style="box-sizing: border-box; padding: 0px 5px;">60</li><li style="box-sizing: border-box; padding: 0px 5px;">61</li><li style="box-sizing: border-box; padding: 0px 5px;">62</li><li style="box-sizing: border-box; padding: 0px 5px;">63</li><li style="box-sizing: border-box; padding: 0px 5px;">64</li><li style="box-sizing: border-box; padding: 0px 5px;">65</li><li style="box-sizing: border-box; padding: 0px 5px;">66</li><li style="box-sizing: border-box; padding: 0px 5px;">67</li><li style="box-sizing: border-box; padding: 0px 5px;">68</li><li style="box-sizing: border-box; padding: 0px 5px;">69</li><li style="box-sizing: border-box; padding: 0px 5px;">70</li><li style="box-sizing: border-box; padding: 0px 5px;">71</li><li style="box-sizing: border-box; padding: 0px 5px;">72</li><li style="box-sizing: border-box; padding: 0px 5px;">73</li><li style="box-sizing: border-box; padding: 0px 5px;">74</li><li style="box-sizing: border-box; padding: 0px 5px;">75</li><li style="box-sizing: border-box; padding: 0px 5px;">76</li><li style="box-sizing: border-box; padding: 0px 5px;">77</li><li style="box-sizing: border-box; padding: 0px 5px;">78</li><li style="box-sizing: border-box; padding: 0px 5px;">79</li><li style="box-sizing: border-box; padding: 0px 5px;">80</li><li style="box-sizing: border-box; padding: 0px 5px;">81</li><li style="box-sizing: border-box; padding: 0px 5px;">82</li><li style="box-sizing: border-box; padding: 0px 5px;">83</li><li style="box-sizing: border-box; padding: 0px 5px;">84</li><li style="box-sizing: border-box; padding: 0px 5px;">85</li><li style="box-sizing: border-box; padding: 0px 5px;">86</li><li style="box-sizing: border-box; padding: 0px 5px;">87</li><li style="box-sizing: border-box; padding: 0px 5px;">88</li><li style="box-sizing: border-box; padding: 0px 5px;">89</li></ul>